<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi Pro - SDN Kakatua</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Poppins', 'sans-serif'] },
                    colors: { brand: { 50: '#ecfdf5', 500: '#10b981', 600: '#059669' } }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f8fafc; }
        .att-radio { display: none; }
        .att-label { transition: all 0.2s; }
        
        /* Warna Status Radio Button */
        .att-radio:checked + .lbl-h { background: #10b981; color: white; border-color: #10b981; transform: translateY(-2px); box-shadow: 0 4px 6px rgba(16, 185, 129, 0.3); }
        .att-radio:checked + .lbl-s { background: #f59e0b; color: white; border-color: #f59e0b; transform: translateY(-2px); box-shadow: 0 4px 6px rgba(245, 158, 11, 0.3); }
        .att-radio:checked + .lbl-i { background: #3b82f6; color: white; border-color: #3b82f6; transform: translateY(-2px); box-shadow: 0 4px 6px rgba(59, 130, 246, 0.3); }
        .att-radio:checked + .lbl-a { background: #ef4444; color: white; border-color: #ef4444; transform: translateY(-2px); box-shadow: 0 4px 6px rgba(239, 68, 68, 0.3); }

        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-bottom: 1px solid #e2e8f0; }
        
        /* Tooltip CSS */
        [data-title]:hover::after {
            content: attr(data-title);
            position: absolute;
            bottom: -35px;
            left: 50%;
            transform: translateX(-50%);
            background: #334155;
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 50;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        /* Animasi */
        .modal-enter { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="text-slate-600 antialiased pb-24">

<nav class="glass sticky top-0 z-40 w-full shadow-sm">
    <div class="max-w-6xl mx-auto px-4 h-16 flex justify-between items-center">
        
        <div class="flex items-center gap-3">
            <div class="w-9 h-9 rounded-lg bg-brand-500 flex items-center justify-center text-white shadow-lg shadow-brand-500/30">
                <i class="fas fa-feather-alt"></i>
            </div>
            <div class="hidden sm:block leading-none">
                <h1 class="font-bold text-slate-800">SDN Kakatua</h1>
            </div>
            
            <button onclick="toggleSchedule()" class="ml-2 px-3 py-1.5 rounded-full bg-slate-100 text-slate-500 hover:bg-brand-50 hover:text-brand-600 border border-slate-200 text-xs font-bold transition flex items-center gap-2 group">
                <i class="fas fa-calendar-alt text-brand-500 group-hover:scale-110 transition"></i> 
                <span class="hidden sm:inline">Jadwal</span>
            </button>
        </div>

        <div class="absolute left-1/2 -translate-x-1/2 flex items-center bg-slate-100 rounded-full p-1 shadow-inner">
            <button onclick="changeDate(-1)" class="w-8 h-8 rounded-full hover:bg-white hover:text-brand-600 transition"><i class="fas fa-chevron-left"></i></button>
            <input type="date" id="input-date" class="bg-transparent border-none text-xs font-bold w-28 text-center focus:ring-0 outline-none cursor-pointer">
            <button onclick="changeDate(1)" class="w-8 h-8 rounded-full hover:bg-white hover:text-brand-600 transition"><i class="fas fa-chevron-right"></i></button>
        </div>

        <div class="flex items-center gap-3">
            <button onclick="toggleImageModal()" class="px-3 py-1.5 rounded-full bg-slate-100 text-slate-500 hover:bg-blue-50 hover:text-blue-600 border border-slate-200 text-xs font-bold transition flex items-center gap-2 group">
                <i class="fas fa-image text-blue-500 group-hover:scale-110 transition"></i> 
                <span class="hidden sm:inline">Struktur</span>
            </button>

            <div id="sync-indicator" class="text-[10px] font-bold text-slate-400 flex items-center gap-1">
                <i class="fas fa-cloud"></i> <span id="sync-text">Offline</span>
            </div>
        </div>
    </div>
</nav>


    <main class="max-w-6xl mx-auto px-4 mt-6">

        <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
            
            <div class="relative w-full md:w-1/3 group">
                <input type="text" id="search-box" onkeyup="filterStudents()" placeholder="Cari siswa..." class="w-full pl-9 pr-4 py-2.5 rounded-xl border border-slate-200 focus:border-brand-500 focus:ring-1 focus:ring-brand-500 text-sm transition-all shadow-sm">
                <i class="fas fa-search absolute left-3 top-3 text-slate-400 group-focus-within:text-brand-500"></i>
            </div>

            <div class="flex gap-2 flex-wrap justify-center">
                <input type="file" id="file-upload" class="hidden" accept=".xlsx, .xls">
                <input type="file" id="file-restore" class="hidden" accept=".xlsx, .xls">

                <button onclick="setApiUrl()" class="w-10 h-10 rounded-xl bg-white border border-slate-200 text-slate-500 hover:text-blue-500 hover:border-blue-200 hover:bg-blue-50 shadow-sm transition relative" data-title="Hubungkan Server">
                    <i class="fas fa-link"></i>
                </button>
                
                <div class="w-px h-10 bg-slate-300 mx-1"></div>

                <button onclick="document.getElementById('file-upload').click()" class="w-10 h-10 rounded-xl bg-white border border-slate-200 text-slate-500 hover:text-emerald-500 hover:border-emerald-200 hover:bg-emerald-50 shadow-sm transition relative" data-title="Import Siswa Baru">
                    <i class="fas fa-file-import"></i>
                </button>

                <button onclick="document.getElementById('file-restore').click()" class="w-10 h-10 rounded-xl bg-white border border-slate-200 text-slate-500 hover:text-violet-500 hover:border-violet-200 hover:bg-violet-50 shadow-sm transition relative" data-title="Restore Backup">
                    <i class="fas fa-history"></i>
                </button>

                <button onclick="downloadTemplate()" class="w-10 h-10 rounded-xl bg-white border border-slate-200 text-slate-500 hover:text-orange-500 hover:border-orange-200 hover:bg-orange-50 shadow-sm transition relative" data-title="Download Template">
                    <i class="fas fa-download"></i>
                </button>

                <button onclick="shareAttendance()" class="w-10 h-10 rounded-xl bg-white border border-slate-200 text-slate-500 hover:text-indigo-500 hover:border-indigo-200 hover:bg-indigo-50 shadow-sm transition relative" data-title="Share ke WA">
                    <i class="fas fa-share-alt"></i>
                </button>

                <button onclick="exportReport()" class="w-10 h-10 rounded-xl bg-brand-500 border border-brand-600 text-white hover:bg-brand-600 shadow-md shadow-brand-500/30 transition relative" data-title="Export Excel">
                    <i class="fas fa-file-excel"></i>
                </button>

                <div class="w-px h-10 bg-slate-300 mx-1"></div>

                <button onclick="resetData()" class="w-10 h-10 rounded-xl bg-white border border-slate-200 text-red-400 hover:text-red-600 hover:border-red-200 hover:bg-red-50 shadow-sm transition relative" data-title="Reset Aplikasi">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>
        </div>

        <div class="grid grid-cols-4 gap-3 mb-6">
            <div class="bg-white p-3 rounded-xl border border-slate-100 shadow-sm flex flex-col items-center">
                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Hadir</span>
                <span class="text-xl font-bold text-emerald-500" id="count-h">0</span>
            </div>
            <div class="bg-white p-3 rounded-xl border border-slate-100 shadow-sm flex flex-col items-center">
                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Sakit</span>
                <span class="text-xl font-bold text-amber-500" id="count-s">0</span>
            </div>
            <div class="bg-white p-3 rounded-xl border border-slate-100 shadow-sm flex flex-col items-center">
                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Izin</span>
                <span class="text-xl font-bold text-blue-500" id="count-i">0</span>
            </div>
            <div class="bg-white p-3 rounded-xl border border-slate-100 shadow-sm flex flex-col items-center">
                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Alpha</span>
                <span class="text-xl font-bold text-red-500" id="count-a">0</span>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden min-h-[400px]">
            <table class="w-full text-left">
                <thead>
                    <tr class="bg-slate-50 border-b border-slate-200 text-[10px] font-bold text-slate-500 uppercase">
                        <th class="p-4 text-center w-12">#</th>
                        <th class="p-4">Siswa</th>
                        <th class="p-4 text-center">Kehadiran</th>
                    </tr>
                </thead>
                <tbody id="attendance-list" class="divide-y divide-slate-100 text-sm"></tbody>
            </table>
            
            <div id="empty-state" class="hidden py-16 text-center">
                <div class="inline-block p-4 rounded-full bg-slate-50 mb-3"><i class="fas fa-inbox text-3xl text-slate-300"></i></div>
                <p class="text-slate-500 text-sm">Data Kosong</p>
            </div>
        </div>

    </main>

    <div id="schedule-modal" class="fixed inset-0 z-50 hidden transition-opacity duration-300">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" onclick="toggleSchedule()"></div>
        
        <div class="relative top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md px-4 h-full max-h-[85vh] flex flex-col">
            <div class="bg-white rounded-2xl shadow-2xl overflow-hidden modal-enter flex flex-col h-full">
                
                <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-white z-10 sticky top-0">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-brand-100 text-brand-600 flex items-center justify-center">
                            <i class="fas fa-calendar-day"></i>
                        </div>
                        <h3 class="font-bold text-slate-700">Jadwal Pelajaran</h3>
                    </div>
                    <button onclick="toggleSchedule()" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 hover:bg-red-50 hover:text-red-500 transition flex items-center justify-center"><i class="fas fa-times"></i></button>
                </div>
                
                <div class="p-4 overflow-y-auto custom-scroll space-y-4 bg-slate-50/50 flex-1">
                    <div class="rounded-xl border border-rose-200 bg-rose-50 overflow-hidden shadow-sm">
                        <div class="bg-rose-100/50 px-4 py-2 border-b border-rose-200 flex justify-between items-center">
                            <h4 class="font-bold text-rose-700">SENIN</h4>
                            <span class="text-[10px] px-2 py-0.5 rounded-full bg-rose-200 text-rose-700 font-semibold">Hari Pertama</span>
                        </div>
                        <div class="p-3 text-sm space-y-2">
                            <div class="flex justify-between text-slate-700"><span class="w-20 font-mono text-slate-400">07:00</span> <span class="font-semibold text-rose-600">Upacara Bendera</span></div>
                            <div class="flex justify-between text-slate-700"><span class="w-20 font-mono text-slate-400">07:30</span> <span>Matematika</span></div>
                            <div class="flex justify-between text-slate-700"><span class="w-20 font-mono text-slate-400">09:15</span> <span>Seni Budaya</span></div>
                            <div class="flex justify-between text-slate-700"><span class="w-20 font-mono text-slate-400">11:15</span> <span>Bahasa Inggris</span></div>
                        </div>
                    </div>
                    <div class="rounded-xl border border-orange-200 bg-orange-50 overflow-hidden shadow-sm">
                        <div class="bg-orange-100/50 px-4 py-2 border-b border-orange-200 flex justify-between items-center">
                            <h4 class="font-bold text-orange-700">SELASA</h4>
                        </div>
                        <div class="p-3 text-sm space-y-2">
                            <div class="flex justify-between text-slate-700"><span class="w-20 font-mono text-slate-400">07:00</span> <span class="font-semibold text-orange-600">Literasi</span></div>
                            <div class="flex justify-between text-slate-700"><span class="w-20 font-mono text-slate-400">07:30</span> <span>Matematika</span></div>
                            <div class="flex justify-between text-slate-700"><span class="w-20 font-mono text-slate-400">09:15</span> <span>Bahasa Indonesia</span></div>
                            <div class="flex justify-between text-slate-700"><span class="w-20 font-mono text-slate-400">11:15</span> <span>IPAS</span></div>
                        </div>
                    </div>
                     <div class="rounded-xl border border-teal-200 bg-teal-50 overflow-hidden shadow-sm">
                        <div class="bg-teal-100/50 px-4 py-2 border-b border-teal-200 flex justify-between items-center">
                            <h4 class="font-bold text-teal-700">RABU</h4>
                        </div>
                        <div class="p-3 text-sm space-y-2">
                            <div class="flex justify-between text-slate-700"><span class="w-20 font-mono text-slate-400">07:00</span> <span class="font-semibold text-teal-600">Rabu Sehat</span></div>
                            <div class="flex justify-between text-slate-700"><span class="w-20 font-mono text-slate-400">07:30</span> <span>PJOK</span></div>
                            <div class="flex justify-between text-slate-700"><span class="w-20 font-mono text-slate-400">10:00</span> <span>Pendidikan Agama</span></div>
                        </div>
                    </div>
                    <div class="rounded-xl border border-sky-200 bg-sky-50 overflow-hidden shadow-sm">
                        <div class="bg-sky-100/50 px-4 py-2 border-b border-sky-200 flex justify-between items-center">
                            <h4 class="font-bold text-sky-700">KAMIS</h4>
                        </div>
                        <div class="p-3 text-sm space-y-2">
                            <div class="flex justify-between text-slate-700"><span class="w-20 font-mono text-slate-400">07:00</span> <span class="font-semibold text-sky-600">Kamis Bakat</span></div>
                            <div class="flex justify-between text-slate-700"><span class="w-20 font-mono text-slate-400">07:30</span> <span>Bahasa Indonesia</span></div>
                            <div class="flex justify-between text-slate-700"><span class="w-20 font-mono text-slate-400">10:00</span> <span>PKN</span></div>
                        </div>
                    </div>
                    <div class="rounded-xl border border-violet-200 bg-violet-50 overflow-hidden shadow-sm">
                        <div class="bg-violet-100/50 px-4 py-2 border-b border-violet-200 flex justify-between items-center">
                            <h4 class="font-bold text-violet-700">JUMAT</h4>
                        </div>
                        <div class="p-3 text-sm space-y-2">
                            <div class="flex justify-between text-slate-700"><span class="w-20 font-mono text-slate-400">07:00</span> <span class="font-semibold text-violet-600">Jumat Ibadah</span></div>
                            <div class="flex justify-between text-slate-700"><span class="w-20 font-mono text-slate-400">07:30</span> <span>Bahasa Daerah</span></div>
                            <div class="flex justify-between text-slate-700"><span class="w-20 font-mono text-slate-400">09:15</span> <span>IPAS</span></div>
                        </div>
                    </div>
                </div>
                <div class="p-3 bg-slate-50 text-center text-xs text-slate-400 border-t border-slate-200">
                    Kelas 3B Semester Genap
                </div>
            </div>
        </div>
    </div>

    <script>
        const STORAGE_KEY_STUDENTS = 'kakatua_std';
        const STORAGE_KEY_RECORDS = 'kakatua_rec';
        const STORAGE_KEY_API = 'kakatua_api';
        
        let students = [];
        let records = {}; 
        let GAS_API_URL = localStorage.getItem(STORAGE_KEY_API) || '';

        // Tanggal Hari Ini
        const now = new Date();
        const y = now.getFullYear();
        const m = String(now.getMonth() + 1).padStart(2,'0');
        const d = String(now.getDate()).padStart(2,'0');
        let currentDate = `${y}-${m}-${d}`;

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            document.getElementById('input-date').value = currentDate;
            document.getElementById('input-date').addEventListener('change', (e) => {
                currentDate = e.target.value; renderTable();
            });
            document.getElementById('file-upload').addEventListener('change', handleImport);
            document.getElementById('file-restore').addEventListener('change', handleRestore);
            
            if(GAS_API_URL) updateSyncStatus('Ready', 'text-emerald-500');
        });

        // --- FUNGSI TOGGLE JADWAL ---
        function toggleSchedule() {
            const modal = document.getElementById('schedule-modal');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
            } else {
                modal.classList.add('hidden');
            }
        }

        function loadData() {
            const s = localStorage.getItem(STORAGE_KEY_STUDENTS);
            const r = localStorage.getItem(STORAGE_KEY_RECORDS);
            if(s) students = JSON.parse(s);
            if(r) records = JSON.parse(r);
            renderTable();
        }

        function saveData() {
            localStorage.setItem(STORAGE_KEY_RECORDS, JSON.stringify(records));
            updateStats();
        }

        function updateAttendance(id, val) {
            if (!records[currentDate]) records[currentDate] = {};
            records[currentDate][id] = val;
            saveData();
            sendToGoogleSheet(id, val, currentDate);
        }

        function sendToGoogleSheet(id, val, dateStr) {
            if (!GAS_API_URL) return;

            const s = students.find(x => x.id === id);
            if(!s) return;

            updateSyncStatus('Syncing', 'text-amber-500 animate-pulse');

            const payload = {
                id: s.id, nis: s.nis, name: s.name,
                date: dateStr, status: val
            };

            fetch(GAS_API_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(() => {
                updateSyncStatus('Saved', 'text-emerald-500');
                setTimeout(() => updateSyncStatus('Ready', 'text-emerald-600'), 2000);
            })
            .catch(e => {
                console.error(e);
                updateSyncStatus('Error', 'text-red-500');
            });
        }

        function renderTable() {
            const tbody = document.getElementById('attendance-list');
            const empty = document.getElementById('empty-state');
            const search = document.getElementById('search-box').value.toLowerCase();
            
            tbody.innerHTML = '';
            const filtered = students.filter(s => s.name.toLowerCase().includes(search));

            if(students.length === 0 || filtered.length === 0) {
                empty.classList.remove('hidden');
            } else {
                empty.classList.add('hidden');
                
                if (!records[currentDate]) records[currentDate] = {};

                filtered.forEach((student, i) => {
                    const status = records[currentDate][student.id] || '';
                    const init = student.name.substring(0,2).toUpperCase();
                    
                    const row = `
                    <tr class="group hover:bg-slate-50 transition">
                        <td class="p-4 text-center text-xs text-slate-400 font-mono">${i+1}</td>
                        <td class="p-4">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-xs font-bold text-slate-500">${init}</div>
                                <div>
                                    <div class="font-bold text-slate-700 text-sm">${student.name}</div>
                                    <div class="text-[10px] text-slate-400">NIS: ${student.nis}</div>
                                </div>
                            </div>
                        </td>
                        <td class="p-4">
                            <div class="flex justify-center bg-slate-100 rounded-lg p-1 w-max mx-auto gap-1">
                                ${radioBtn(student.id, 'H', 'H', status, 'lbl-h')}
                                ${radioBtn(student.id, 'S', 'S', status, 'lbl-s')}
                                ${radioBtn(student.id, 'I', 'I', status, 'lbl-i')}
                                ${radioBtn(student.id, 'A', 'A', status, 'lbl-a')}
                            </div>
                        </td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            }
            updateStats();
        }

        function radioBtn(id, val, label, curr, css) {
            const chk = curr === val ? 'checked' : '';
            return `
            <div class="relative">
                <input type="radio" id="${id}_${val}" name="att_${id}" value="${val}" class="att-radio" onchange="updateAttendance('${id}', '${val}')" ${chk}>
                <label for="${id}_${val}" class="att-label ${css} block w-8 h-7 rounded flex items-center justify-center text-xs font-bold text-slate-400 cursor-pointer hover:bg-white border border-transparent">
                    ${label}
                </label>
            </div>`;
        }

        function updateStats() {
            let c = {H:0, S:0, I:0, A:0};
            if(records[currentDate]) {
                Object.values(records[currentDate]).forEach(v => { if(c[v]!==undefined) c[v]++ });
            }
            ['H','S','I','A'].forEach(k => document.getElementById(`count-${k.toLowerCase()}`).innerText = c[k]);
        }

        // --- IMPORT / RESTORE / EXPORT ---

        function handleImport(e) {
            const f = e.target.files[0];
            if(!f) return;
            const r = new FileReader();
            r.onload = (evt) => {
                const wb = XLSX.read(evt.target.result, {type:'array'});
                const js = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                const newS = js.map((x,i) => ({ id:'S'+(Date.now()+i), nis:x['NIS']||x['nis']||'-', name:x['Nama']||x['nama']||'Siswa Baru' }));
                
                Swal.fire({title:'Import Data?', text:'Data lama akan dihapus!', showCancelButton:true}).then(res=>{
                    if(res.isConfirmed){ students=newS; records={}; localStorage.setItem(STORAGE_KEY_STUDENTS, JSON.stringify(students)); localStorage.removeItem(STORAGE_KEY_RECORDS); renderTable(); }
                });
            };
            r.readAsArrayBuffer(f);
            e.target.value = '';
        }

        function handleRestore(e) {
            const f = e.target.files[0];
            if(!f) return;
            const r = new FileReader();
            r.onload = (evt) => {
                try {
                    const wb = XLSX.read(evt.target.result, {type:'array'});
                    const rawData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                    if(rawData.length === 0) throw new Error("File Kosong");

                    let restoredStudents = [];
                    let restoredRecords = {};
                    const dateRegex = /^\d{4}-\d{2}-\d{2}$/;

                    rawData.forEach((row, idx) => {
                        const sId = 'RES_' + idx + '_' + Date.now();
                        restoredStudents.push({
                            id: sId,
                            nis: row['NIS'] || row['nis'] || '-',
                            name: row['Nama'] || row['nama'] || 'Tanpa Nama'
                        });
                        Object.keys(row).forEach(key => {
                            if (dateRegex.test(key)) {
                                const val = row[key];
                                if (['H','S','I','A'].includes(val)) {
                                    if (!restoredRecords[key]) restoredRecords[key] = {};
                                    restoredRecords[key][sId] = val;
                                }
                            }
                        });
                    });

                    Swal.fire({title: 'Restore Berhasil', text: `Dipulihkan: ${restoredStudents.length} siswa`, icon: 'success'}).then(() => {
                        students = restoredStudents; records = restoredRecords;
                        localStorage.setItem(STORAGE_KEY_STUDENTS, JSON.stringify(students));
                        localStorage.setItem(STORAGE_KEY_RECORDS, JSON.stringify(records));
                        renderTable();
                    });
                } catch(err) { Swal.fire('Gagal', 'Format salah', 'error'); }
            };
            r.readAsArrayBuffer(f);
            e.target.value = '';
        }

        function downloadTemplate() {
            const ws = XLSX.utils.json_to_sheet([{NIS:"123", Nama:"Siswa A"}]);
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Siswa");
            XLSX.writeFile(wb, "Template.xlsx");
        }

        function exportReport() {
            if(students.length===0) return;
            const data = students.map((s,i) => {
                let row = {No:i+1, NIS:s.nis, Nama:s.name};
                let tot = {H:0, S:0, I:0, A:0};
                Object.keys(records).sort().forEach(date => {
                    const st = records[date][s.id];
                    if(st) { row[date] = st; tot[st]++; }
                });
                row['Total H'] = tot.H; row['Total S'] = tot.S;
                row['Total I'] = tot.I; row['Total A'] = tot.A;
                return row;
            });
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Rekap");
            XLSX.writeFile(wb, "Rekap_Absensi.xlsx");
        }

        // --- SHARE FEATURE (NEW) ---
        function shareAttendance() {
            // 1. Format Tanggal
            const parts = currentDate.split('-');
            const myDate = new Date(parts[0], parts[1] - 1, parts[2]); 
            const dateStr = myDate.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            // 2. Filter & Group Data
            let sList = [], iList = [], aList = [];
            
            if(records[currentDate]) {
                students.forEach(s => {
                    const status = records[currentDate][s.id];
                    // Format nama: Kapital Awal Kata
                    const namaRapi = s.name.replace(/\b\w/g, l => l.toUpperCase());
                    
                    if(status === 'S') sList.push(namaRapi);
                    else if(status === 'I') iList.push(namaRapi);
                    else if(status === 'A') aList.push(namaRapi);
                });
            }

            const makeList = (arr) => arr.length > 0 ? arr.map(n => `- ${n}`).join('\n') : '- ---';

            let message = `*Laporan Absensi Kelas*\n${dateStr}\n\n`;
            message += `*Sakit:*\n${makeList(sList)}\n\n`;
            message += `*Izin:*\n${makeList(iList)}\n\n`;
            message += `*Tanpa Keterangan:*\n${makeList(aList)}`;

            // 3. Share Action
            if (navigator.share) {
                navigator.share({ title: 'Rekap Absensi', text: message }).catch(console.error);
            } else {
                navigator.clipboard.writeText(message).then(() => {
                    Swal.fire({
                        icon: 'success',
                        title: 'Teks Disalin!',
                        text: 'Silakan Paste di WhatsApp Web.',
                        timer: 1500,
                        showConfirmButton: false
                    });
                });
            }
        }

        function setApiUrl() {
            Swal.fire({title:'Link Google Sheet', input:'text', inputValue:GAS_API_URL}).then(r=>{
                if(r.value){ GAS_API_URL=r.value; localStorage.setItem(STORAGE_KEY_API,GAS_API_URL); updateSyncStatus('Ready','text-emerald-500'); }
            });
        }

        function resetData() {
            Swal.fire({title:'Reset Data?', showCancelButton:true, icon:'warning'}).then(r=>{
                if(r.isConfirmed){ localStorage.clear(); location.reload(); }
            });
        }

        function changeDate(d) {
            const dt = new Date(currentDate); dt.setDate(dt.getDate()+d);
            currentDate = dt.toISOString().split('T')[0];
            document.getElementById('input-date').value = currentDate;
            renderTable();
        }

        function filterStudents() { renderTable(); }
        function updateSyncStatus(txt, cls) {
            document.getElementById('sync-text').innerText = txt;
            document.getElementById('sync-indicator').className = `text-[10px] font-bold flex items-center gap-1 ${cls}`;
        }
        
        // Fungsi untuk buka/tutup modal gambar
function toggleImageModal() {
    const modal = document.getElementById('image-modal');
    if (modal.classList.contains('hidden')) {
        modal.classList.remove('hidden');
    } else {
        modal.classList.add('hidden');
    }
}

    </script>
    
    
    
    <div id="image-modal" class="fixed inset-0 z-50 hidden transition-opacity duration-300">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="toggleImageModal()"></div>
    
    <div class="relative top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-2xl px-4">
        <div class="bg-white rounded-2xl shadow-2xl overflow-hidden modal-enter flex flex-col">
            
            <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-white">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center">
                        <i class="fas fa-image"></i>
                    </div>
                    <h3 class="font-bold text-slate-700">Jadwal Mapel Printable</h3>
                </div>
                <button onclick="toggleImageModal()" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 hover:bg-red-50 hover:text-red-500 transition flex items-center justify-center">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="p-2 bg-slate-50 flex justify-center">
                <img src="https://sdnkakatua.github.io/img/abc.jpg" 
                     alt="Struktur Kelas" 
                     class="w-full h-auto rounded-xl shadow-inner border border-slate-200 object-cover">
            </div>

            <div class="p-3 bg-white text-center text-[10px] text-slate-400 italic">
                *Klik di luar area atau tombol silang untuk menutup
            </div>
        </div>
    </div>
</div>


</body>
</html>
