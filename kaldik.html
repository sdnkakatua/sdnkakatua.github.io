<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#800000">
    <title>Sistem Kalender Akademik Sekolah</title>
    
    <style>
        :root {
            /* --- WARNA DASAR --- */
            --bg-body: #f4f6f8; 
            --bg-card: #ffffff; 
            --bg-input: #ffffff;
            --text-main: #2d3436; 
            --text-muted: #636e72; 
            --border-color: #dfe6e9;
            
            /* --- IDENTITAS SEKOLAH --- */
            --primary: #800000; 
            --accent: #d4af37;
            --header-pattern: repeating-linear-gradient(45deg, #800000, #800000 10px, #600000 10px, #600000 20px);

            /* --- KATEGORI WARNA --- */
            --c-libur-bg: #ffebee; --c-libur-text: #b71c1c;
            --c-ujian-bg: #fff8e1; --c-ujian-text: #e65100;
            --c-mpls-bg: #e8f5e9;  --c-mpls-text: #1b5e20;
            --c-rapor-bg: #f3e5f5; --c-rapor-text: #4a148c;
        }

        body.dark-mode {
            --bg-body: #121212; --bg-card: #1e1e1e; --bg-input: #2c2c2c; 
            --text-main: #ececec; --text-muted: #b0b0b0; --border-color: #333;
            --c-libur-bg: #5c1b1b; --c-libur-text: #ffcdd2; 
            --c-ujian-bg: #573a00; --c-ujian-text: #ffe0b2;
            --c-mpls-bg: #143818;  --c-mpls-text: #c8e6c9; 
            --c-rapor-bg: #34124a; --c-rapor-text: #e1bee7;
        }

        * { box-sizing: border-box; transition: background 0.3s, color 0.3s; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg-body); color: var(--text-main); margin: 0; min-height: 100vh; display: flex; flex-direction: column; overflow-x: hidden; }

        /* HEADER */
        header {
            background: var(--header-pattern); color: white; padding: 15px 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); border-bottom: 5px solid var(--accent);
            display: flex; justify-content: space-between; align-items: center;
        }
        .header-left { display: flex; align-items: center; gap: 10px; }
        
        /* SYNC INDICATOR */
        .sync-status { width: 30px; height: 30px; background: rgba(0,0,0,0.3); border-radius: 50%; display: flex; justify-content: center; align-items: center; border: 1px solid rgba(255,255,255,0.3); }
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: #ccc; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
        .sync-dot.synced { background: #2ecc71; box-shadow: 0 0 8px #2ecc71; }
        .sync-dot.syncing { background: #f1c40f; animation: pulse 1s infinite; }
        .sync-dot.offline { background: #e74c3c; }
        @keyframes pulse { 0% { transform: scale(0.8); opacity: 0.5; } 100% { transform: scale(1.2); opacity: 1; } }

        .header-content h1 { margin: 0; font-size: clamp(1.2rem, 3vw, 1.8rem); font-family: 'Georgia', serif; }
        .header-content p { margin: 0; font-size: 0.9rem; opacity: 0.9; }

        .btn-admin-login {
            background: rgba(0,0,0,0.2); border: 1px solid var(--accent); color: var(--accent);
            padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 0.85rem; font-weight: bold;
            transition: 0.3s;
        }
        .btn-admin-login:hover, .btn-admin-login.active { background: var(--accent); color: #800000; box-shadow: 0 0 10px var(--accent); }

        /* LAYOUT */
        .main-container { flex: 1; display: flex; gap: 20px; padding: 20px; max-width: 1600px; margin: 0 auto; width: 100%; padding-bottom: 80px; }
        
        /* CALENDAR */
        .calendar-wrapper { flex: 3; background: var(--bg-card); border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border: 1px solid var(--border-color); display: flex; flex-direction: column; }
        .cal-controls { display: flex; align-items: center; padding: 15px; background: var(--bg-body); gap: 10px; border-bottom: 1px solid var(--border-color); }
        .btn-nav { background: var(--primary); color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); margin-left: auto; font-size: 0.85rem; }
        .current-month { font-size: 1.3rem; font-weight: bold; color: var(--primary); flex-grow: 1; text-align: center; font-family: 'Georgia', serif; }
        .cal-header { display: grid; grid-template-columns: repeat(7, 1fr); background: var(--primary); color: white; text-align: center; padding: 10px 0; font-weight: bold; font-size: 0.9rem; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); padding: 5px; gap: 5px; min-height: 400px; }
        .day-cell { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 6px; padding: 5px; min-height: 90px; cursor: pointer; display: flex; flex-direction: column; position: relative; user-select: none; }
        .day-cell.today { border: 2px solid var(--accent); background: linear-gradient(135deg, var(--bg-card), rgba(212, 175, 55, 0.08)); }
        .day-cell.empty { background: transparent; border: none; cursor: default; }
        .date-num { font-weight: bold; margin-bottom: 5px; font-size: 1rem; color: var(--text-muted); }
        .date-num.red { color: #e74c3c; }
        .event-dot { font-size: 0.75rem; padding: 3px 6px; border-radius: 4px; margin-bottom: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; border-left: 3px solid rgba(0,0,0,0.2); font-weight: 600; }
        .bg-libur { background: var(--c-libur-bg); color: var(--c-libur-text); }
        .bg-ujian { background: var(--c-ujian-bg); color: var(--c-ujian-text); }
        .bg-mpls { background: var(--c-mpls-bg); color: var(--c-mpls-text); }
        .bg-rapor { background: var(--c-rapor-bg); color: var(--c-rapor-text); }

        /* SEMESTER & SIDEBAR */
        .semester-view { display: none; padding: 20px; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .semester-view.active { display: grid; }
        .mini-month { border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; cursor: pointer; background: var(--bg-body); }
        .mini-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; font-size: 0.6rem; text-align: center; }
        .mini-cell { height: 25px; background: var(--bg-card); display: flex; justify-content: center; align-items: center; border-radius: 3px; }
        .mini-cell.has-event { background: var(--accent); color: white; }
        .sidebar { flex: 1; min-width: 300px; display: flex; flex-direction: column; gap: 20px; }
        .widget-box { background: var(--bg-card); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .stat-flex { display: flex; justify-content: space-around; text-align: center; margin-top: 10px; }
        .stat-item strong { display: block; font-size: 1.8rem; }
        .agenda-list { max-height: 400px; overflow-y: auto; }
        .agenda-item { display: flex; gap: 10px; border-bottom: 1px solid var(--border-color); padding: 10px 0; font-size: 0.9rem; }
        .agenda-date { font-weight: bold; color: var(--primary); min-width: 30px; }

        /* --- UI ESTETIK --- */
        .modal-overlay, .custom-modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); 
            z-index: 3000; display: none; justify-content: center; align-items: center; 
            opacity: 0; transition: opacity 0.3s ease; 
        }
        .modal-overlay.active, .custom-modal-overlay.active { display: flex; opacity: 1; }

        /* CARDS */
        .modal-card, .login-card, .confirm-card {
            background: var(--bg-card); width: 95%; max-width: 450px;
            border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            border: 1px solid var(--border-color); overflow: hidden;
            transform: translateY(20px); transition: transform 0.3s;
            display: flex; flex-direction: column;
        }
        .active .modal-card, .active .login-card, .active .confirm-card { transform: translateY(0); }
        .confirm-card { text-align: center; padding: 30px; max-width: 320px; }
        .login-card { text-align: center; padding: 30px; max-width: 350px; }

        .modal-header { background: var(--primary); color: white; padding: 20px; text-align: center; }
        .modal-body { padding: 20px; overflow-y: auto; max-height: 70vh; }

        /* LIST EVENT (READ ONLY) */
        .event-item-admin { display: flex; justify-content: space-between; align-items: center; padding: 12px; margin-bottom: 8px; background: var(--bg-body); border-radius: 8px; border-left: 4px solid #ccc; border: 1px solid var(--border-color); }
        
        /* --- ADMIN FORM YANG DIPERBAIKI (MARGIN & SPACING) --- */
        .admin-form { 
            display: none; 
            margin-top: 25px; 
            padding: 20px; 
            background-color: var(--bg-body); /* Memberikan kontras */
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }
        .admin-form.show { display: block; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Input Spacing Improved */
        .form-group { margin-bottom: 15px; } 
        .form-group label { display: block; font-size: 0.85rem; margin-bottom: 8px; color: var(--text-muted); font-weight: 600; }
        
        .form-group input, .form-group select { 
            width: 100%; padding: 12px; 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            background: var(--bg-input); 
            color: var(--text-main); 
            font-size: 0.95rem;
        }
        .form-group input:focus, .form-group select:focus {
            border-color: var(--accent); outline: none; box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }

        .btn-action-small { border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; color: white; font-size: 0.8rem; margin-left: 5px; font-weight: bold; }
        .btn-primary-block { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        .btn-primary-block:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(128,0,0,0.3); }

        /* LOGIN & CONFIRM ICONS */
        .modal-icon { width: 60px; height: 60px; background: var(--bg-body); border-radius: 50%; margin: 0 auto 15px; display: flex; justify-content: center; align-items: center; color: var(--primary); font-size: 1.5rem; border: 2px solid var(--accent); }
        .modal-icon.warning { color: #e67e22; border-color: #e67e22; }
        
        /* LOGIN INPUTS */
        .custom-input-group { position: relative; margin-bottom: 15px; text-align: left; }
        .custom-input-group label { display: block; font-size: 0.8rem; margin-bottom: 5px; color: var(--text-muted); font-weight: 600; }
        .custom-input { width: 100%; padding: 12px; border-radius: 8px; border: 2px solid var(--border-color); background: var(--bg-input); color: var(--text-main); outline: none; }
        .custom-input:focus { border-color: var(--accent); }

        /* CONFIRM BUTTONS */
        .confirm-actions { display: flex; gap: 10px; margin-top: 20px; }
        .btn-confirm-cancel { flex: 1; background: transparent; border: 1px solid var(--border-color); color: var(--text-muted); padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-confirm-yes { flex: 1; background: #c0392b; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold; }

        /* TOAST & FAB */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 7000; display: flex; flex-direction: column; gap: 10px; }
        .toast { min-width: 250px; background: var(--bg-card); padding: 15px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.15); display: flex; gap: 12px; border-left: 5px solid; transform: translateX(100%); opacity: 0; transition: all 0.4s; }
        .toast.show { transform: translateX(0); opacity: 1; }
        .toast.success { border-left-color: #27ae60; } .toast.error { border-left-color: #c0392b; } .toast.info { border-left-color: #2980b9; }
        .fab { position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px; background: var(--text-main); color: var(--bg-card); border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 2000; }
        
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body); z-index: 5000; display: flex; justify-content: center; align-items: center; flex-direction: column; color: var(--primary); }

        @media (max-width: 850px) { .main-container { flex-direction: column; } .sidebar { width: 100%; } }
    </style>
</head>
<body>

<header>
    <div class="header-left">
        <div class="sync-status" title="Status Sinkronisasi">
            <div id="syncIndicator" class="sync-dot synced"></div>
        </div>
        <div class="header-content">
            <h1>SDN KAKATUA</h1>
            <p>Kalender Akademik 2025/2026</p>
        </div>
    </div>
    <button class="btn-admin-login" onclick="toggleAdminMode()" id="btnAdmin">Login Admin</button>
</header>

<div class="main-container">
    <div class="calendar-wrapper">
        <div class="cal-controls">
            <button class="btn-nav" onclick="changeMonth(-1)">&#10094;</button>
            <div class="current-month" id="monthDisplay">Juli 2025</div>
            <button class="btn-nav" onclick="changeMonth(1)">&#10095;</button>
            <button class="btn-nav btn-outline" onclick="toggleSemesterView()" id="btnSemesterToggle">Lihat Semester</button>
        </div>
        <div id="monthViewContainer">
            <div class="cal-header"><div>MIN</div><div>SEN</div><div>SEL</div><div>RAB</div><div>KAM</div><div>JUM</div><div>SAB</div></div>
            <div class="cal-grid" id="calendarGrid"></div>
        </div>
        <div class="semester-view" id="semesterViewGrid"></div>
    </div>

    <div class="sidebar">
        <div class="widget-box">
            <h4>Statistik Bulan Ini</h4>
            <div class="stat-flex">
                <div><strong id="statEfektif" style="color: green;">0</strong><small>Hari Efektif</small></div>
                <div><strong id="statLibur" style="color: red;">0</strong><small>Hari Libur</small></div>
            </div>
        </div>
        <div class="widget-box" style="flex: 1;">
            <h4>Agenda</h4>
            <div class="agenda-list" id="agendaList"></div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="dateModal" onclick="closeModal()">
    <div class="modal-card" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2 id="modalDateNum">17</h2>
            <p id="modalDateFull">Agustus 2025</p>
        </div>
        <div class="modal-body">
            <div id="modalContent"></div>
            
            <div id="adminPanel" class="admin-form">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h4 style="margin:0; color:var(--primary);" id="formTitle">Tambah Kegiatan</h4>
                    <button id="btnCancelEdit" onclick="resetForm()" style="display:none; font-size:0.75rem; padding:5px 10px; border:none; background:#ccc; cursor:pointer; border-radius:4px; font-weight:bold;">Batal Edit</button>
                </div>
                
                <input type="hidden" id="oldTitleVal"><input type="hidden" id="oldStartVal">
                
                <div class="form-group">
                    <label>Nama Kegiatan</label>
                    <input type="text" id="inpTitle" placeholder="Misal: Ujian Semester">
                </div>
                
                <div class="form-group" style="display:flex; gap:15px;">
                    <div style="flex:1;">
                        <label>Mulai</label>
                        <input type="date" id="inpStart">
                    </div>
                    <div style="flex:1;">
                        <label>Selesai</label>
                        <input type="date" id="inpEnd">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Jenis Warna</label>
                    <select id="inpType">
                        <option value="bg-libur">Merah (Libur)</option>
                        <option value="bg-ujian">Kuning (Ujian)</option>
                        <option value="bg-mpls">Hijau (Kegiatan/MPLS)</option>
                        <option value="bg-rapor">Ungu (Rapor)</option>
                    </select>
                </div>
                
                <button class="btn-primary-block" onclick="saveEvent()">SIMPAN PERUBAHAN</button>
            </div>
        </div>
        <button onclick="closeModal()" style="padding:15px; background:transparent; border:none; border-top:1px solid var(--border-color); cursor:pointer; width:100%; color:var(--text-muted);">TUTUP</button>
    </div>
</div>

<div class="custom-modal-overlay" id="loginModal" onclick="closeLogin(event)">
    <div class="login-card">
        <div class="modal-icon"><svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg></div>
        <h3>Login Admin</h3>
        <div class="custom-input-group"><label>Username</label><input type="text" id="userIn" class="custom-input"></div>
        <div class="custom-input-group"><label>Password</label><input type="password" id="passIn" class="custom-input"></div>
        <button class="btn-primary-block" onclick="submitLogin()">Masuk</button>
        <button onclick="closeLogin('force')" style="margin-top:10px; background:none; border:none; color:#666; cursor:pointer;">Batal</button>
    </div>
</div>

<div class="custom-modal-overlay" id="confirmModal">
    <div class="confirm-card">
        <div class="modal-icon warning"><svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg></div>
        <h3 id="confirmTitle">Konfirmasi</h3>
        <p id="confirmMsg" style="color:var(--text-muted); margin-bottom:20px;">Yakin?</p>
        <div class="confirm-actions">
            <button id="btnConfNo" class="btn-confirm-cancel">Batal</button>
            <button id="btnConfYes" class="btn-confirm-yes">Ya, Hapus</button>
        </div>
    </div>
</div>

<div class="toast-container" id="toastContainer"></div>
<div class="fab" onclick="document.body.classList.toggle('dark-mode')"><svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></div>

<script>
    // =========================================================
    // CONFIG: GANTI URL DI SINI DENGAN HASIL DEPLOY TERBARU
    // =========================================================
    const APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyjto7qG6kX0CyMYgrRG31UW820WB4hjLyg_nwxNbMjVVOve6XOxknQYHiXXH4Yg98IPQ/exec'; 
    // =========================================================

    let eventsData = []; 
    let syncQueue = JSON.parse(localStorage.getItem('kaldik_queue') || '[]');
    let isAdminMode = false;
    let isSemesterView = false;
    let currentDate = new Date();
    if(currentDate.getFullYear() < 2025) currentDate = new Date(2025, 6, 1);

    const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];

    // --- INIT ---
    init();

    async function init() {
        if(APP_SCRIPT_URL.includes('URL_WEB_APP')) { alert("Ganti URL Script di HTML!"); return; }
        
        // 1. Load from Cache
        const cached = localStorage.getItem('kaldik_events');
        if (cached) { eventsData = JSON.parse(cached); render(); }
        
        // 2. Process Queue
        if (syncQueue.length > 0) processQueue();

        // 3. Fetch Latest
        await fetchLatestData();
    }

    // --- SYNC ---
    async function fetchLatestData() {
        updateSyncIcon('syncing');
        try {
            const res = await fetch(APP_SCRIPT_URL);
            const data = await res.json();
            eventsData = data;
            localStorage.setItem('kaldik_events', JSON.stringify(data)); 
            render();
            updateSyncIcon('synced');
        } catch (e) {
            console.log("Offline");
            updateSyncIcon('offline');
        }
    }

    function addToSyncQueue(payload) {
        // Optimistic UI Update
        if (payload.action === 'add') {
            eventsData.push({startDate: payload.start, endDate: payload.end, title: payload.title, type: payload.type});
        } else if (payload.action === 'delete') {
            eventsData = eventsData.filter(e => !(e.startDate == payload.oldStart && e.title == payload.oldTitle));
        } else if (payload.action === 'edit') {
            const idx = eventsData.findIndex(e => e.startDate == payload.oldStart && e.title == payload.oldTitle);
            if(idx !== -1) eventsData[idx] = {startDate: payload.newStart, endDate: payload.newEnd, title: payload.newTitle, type: payload.newType};
        }
        
        localStorage.setItem('kaldik_events', JSON.stringify(eventsData));
        render(); closeModal();

        // Queue
        syncQueue.push(payload);
        localStorage.setItem('kaldik_queue', JSON.stringify(syncQueue));
        processQueue();
    }

    async function processQueue() {
        if (syncQueue.length === 0) return;
        updateSyncIcon('syncing');
        const payload = syncQueue[0];

        try {
            const res = await fetch(APP_SCRIPT_URL, { method: "POST", body: JSON.stringify(payload) });
            const result = await res.json();

            if (result.status === "success") {
                showToast("Tersimpan", "Data sinkron.", "success");
                syncQueue.shift(); 
                localStorage.setItem('kaldik_queue', JSON.stringify(syncQueue));
                if (syncQueue.length > 0) processQueue(); else updateSyncIcon('synced');
            } else {
                showToast("Gagal Sync", result.message, "error");
                updateSyncIcon('offline');
            }
        } catch (e) {
            console.error("Sync fail");
            updateSyncIcon('offline');
        }
    }

    function updateSyncIcon(status) {
        document.getElementById('syncIndicator').className = `sync-dot ${status}`;
    }

    // --- LOGIN ---
    async function submitLogin() {
        const u = document.getElementById('userIn').value;
        const p = document.getElementById('passIn').value;
        const btn = document.querySelector('.login-card .btn-primary-block');
        btn.innerText = "Memeriksa...";

        try {
            const res = await fetch(APP_SCRIPT_URL, { 
                method: "POST", 
                body: JSON.stringify({ action: 'login', u: u, p: p }) 
            });
            const result = await res.json();

            if (result.status === "success") {
                isAdminMode = true;
                document.getElementById('btnAdmin').innerText = "Admin (Aktif)";
                document.getElementById('btnAdmin').classList.add('active');
                showToast("Login Berhasil", "Mode Admin Aktif", "success");
                closeLogin('force');
            } else {
                showToast("Login Gagal", "Username/Password Salah", "error");
            }
        } catch (e) {
            showToast("Error", "Gagal menghubungi server", "error");
        }
        btn.innerText = "Masuk";
    }

    // --- CRUD ---
    function saveEvent() {
        const title = document.getElementById('inpTitle').value;
        const start = document.getElementById('inpStart').value;
        const end = document.getElementById('inpEnd').value;
        const type = document.getElementById('inpType').value;
        const oldTitle = document.getElementById('oldTitleVal').value;
        const oldStart = document.getElementById('oldStartVal').value;

        if(!title || !start) { showToast("Error", "Data tidak lengkap", "error"); return; }

        let payload = {};
        if (oldTitle && oldStart) {
            payload = { action: "edit", oldTitle: oldTitle, oldStart: oldStart, newTitle: title, newStart: start, newEnd: end||start, newType: type };
        } else {
            payload = { action: "add", title: title, start: start, end: end||start, type: type };
        }
        addToSyncQueue(payload);
    }

    async function deleteEvent(title, start) {
        const yes = await showConfirm("Hapus Kegiatan?", `Hapus "${title}" selamanya?`);
        if (yes) addToSyncQueue({ action: "delete", oldTitle: title, oldStart: start });
    }

    // --- HELPER ---
    function toggleAdminMode() {
        if (!isAdminMode) document.getElementById('loginModal').classList.add('active');
        else {
            isAdminMode = false;
            document.getElementById('btnAdmin').innerText = "Login Admin";
            document.getElementById('btnAdmin').classList.remove('active');
            showToast("Logout", "Mode Admin Nonaktif", "info");
            document.getElementById('adminPanel').classList.remove('show');
        }
    }
    function closeLogin(e) { if(e==='force' || e.target.id === 'loginModal') document.getElementById('loginModal').classList.remove('active'); }
    
    function showToast(title, msg, type) {
        const c = document.getElementById('toastContainer');
        const t = document.createElement('div'); t.className = `toast ${type}`;
        t.innerHTML = `<div class="toast-content"><span class="toast-title">${title}</span><span class="toast-msg">${msg}</span></div>`;
        c.appendChild(t);
        requestAnimationFrame(() => t.classList.add('show'));
        setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 400); }, 3000);
    }

    function showConfirm(title, msg) {
        return new Promise(resolve => {
            const m = document.getElementById('confirmModal');
            document.getElementById('confirmTitle').innerText = title;
            document.getElementById('confirmMsg').innerText = msg;
            m.classList.add('active');
            document.getElementById('btnConfYes').onclick = () => { m.classList.remove('active'); resolve(true); };
            document.getElementById('btnConfNo').onclick = () => { m.classList.remove('active'); resolve(false); };
        });
    }

    function resetForm() {
        document.getElementById('formTitle').innerText = "Tambah Kegiatan";
        document.getElementById('btnCancelEdit').style.display = 'none';
        document.getElementById('inpTitle').value = "";
        document.getElementById('oldTitleVal').value = "";
        document.getElementById('oldStartVal').value = "";
    }

    function prepareEdit(title, start, end, type) {
        document.getElementById('formTitle').innerText = "Edit Kegiatan";
        document.getElementById('btnCancelEdit').style.display = 'inline-block';
        document.getElementById('inpTitle').value = title;
        document.getElementById('inpStart').value = start;
        document.getElementById('inpEnd').value = end;
        document.getElementById('inpType').value = type;
        document.getElementById('oldTitleVal').value = title;
        document.getElementById('oldStartVal').value = start;
        document.getElementById('adminPanel').scrollIntoView({behavior:'smooth'});
    }

    // --- RENDER ---
    function render() {
        if(isSemesterView) { renderSemesterView(); return; }
        const y = currentDate.getFullYear(), m = currentDate.getMonth();
        document.getElementById('monthDisplay').innerText = `${monthNames[m]} ${y}`;
        const grid = document.getElementById('calendarGrid'); grid.innerHTML = '';
        
        const firstDay = new Date(y, m, 1).getDay();
        const daysInM = new Date(y, m+1, 0).getDate();
        let cEfek = 0, cLibur = 0;

        for(let i=0; i<firstDay; i++) grid.appendChild(createCell('', 'empty'));
        for(let i=1; i<=daysInM; i++) {
            const dStr = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            const events = eventsData.filter(e => {
                const s = new Date(e.startDate), end = new Date(e.endDate||e.startDate), c = new Date(dStr);
                return c >= s && c <= end;
            });
            
            const dayIdx = new Date(y, m, i).getDay();
            const isWk = dayIdx===0||dayIdx===6;
            if(isWk || events.some(e=>e.type.includes('libur'))) cLibur++; else cEfek++;

            const cell = createCell(i, 'day-cell ' + (isWk?'red':''));
            const today = new Date();
            if(i===today.getDate() && m===today.getMonth() && y===today.getFullYear()) cell.classList.add('today');
            
            let dots = '';
            events.forEach(e => dots += `<span class="event-dot ${e.type}">${e.title}</span>`);
            cell.innerHTML = `<div class="date-num ${isWk?'red':''}">${i}</div>${dots}`;
            cell.onclick = () => openModal(i, m, y, events);
            grid.appendChild(cell);
        }
        document.getElementById('statEfektif').innerText = cEfek;
        document.getElementById('statLibur').innerText = cLibur;
        renderAgendaList(m);
    }

    function createCell(content, cls) {
        const d = document.createElement('div'); d.className = cls; 
        if(content) d.innerText = content; return d;
    }

    function renderAgendaList(m) {
        const l = document.getElementById('agendaList'); l.innerHTML = '';
        const start = new Date(currentDate.getFullYear(), m, 1);
        const end = new Date(currentDate.getFullYear(), m+1, 0);
        const evs = eventsData.filter(e => { const s = new Date(e.startDate); return s>=start && s<=end; })
                      .sort((a,b)=>new Date(a.startDate)-new Date(b.startDate));
        
        if(evs.length===0) l.innerHTML = '<p style="text-align:center;color:#999">Kosong</p>';
        evs.forEach(e => {
            l.innerHTML += `<div class="agenda-item"><div class="agenda-date">${e.startDate.split('-')[2]}</div><div style="flex:1"><b>${e.title}</b><br><small>${e.startDate}</small></div></div>`;
        });
    }

    function renderSemesterView() {
        const g = document.getElementById('semesterViewGrid'); g.innerHTML = '';
        const startM = currentDate.getMonth() >= 6 ? 6 : 0;
        const yr = currentDate.getFullYear();
        document.getElementById('monthDisplay').innerText = `Semester ${startM===6?'Ganjil':'Genap'} ${yr}`;

        for(let i=0; i<6; i++) {
            const m = startM + i;
            const y = yr + (m>11?1:0);
            const rm = m%12;
            const wrap = document.createElement('div'); wrap.className = 'mini-month';
            wrap.onclick = () => { currentDate.setMonth(rm); toggleSemesterView(); };
            
            let h = `<h4>${monthNames[rm]}</h4><div class="mini-grid">`;
            const dim = new Date(y, rm+1, 0).getDate();
            const fd = new Date(y, rm, 1).getDay();
            for(let k=0; k<fd; k++) h+='<div></div>';
            for(let d=1; d<=dim; d++) {
                const ds = `${y}-${String(rm+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const has = eventsData.some(e => { const s=new Date(e.startDate), en=new Date(e.endDate||e.startDate), c=new Date(ds); return c>=s && c<=en; });
                h += `<div class="mini-cell ${has?'has-event':''}">${d}</div>`;
            }
            wrap.innerHTML = h + '</div>'; g.appendChild(wrap);
        }
    }

    function toggleSemesterView() {
        isSemesterView = !isSemesterView;
        const btn = document.getElementById('btnSemesterToggle');
        document.getElementById('monthViewContainer').style.display = isSemesterView ? 'none' : 'block';
        document.getElementById('semesterViewGrid').style.display = isSemesterView ? 'grid' : 'none';
        btn.innerText = isSemesterView ? "Lihat Bulan" : "Lihat Semester";
        render();
    }
    
    function changeMonth(s) { currentDate.setMonth(currentDate.getMonth()+s); render(); }
    
    function openModal(d, m, y, evs) {
        resetForm();
        const ds = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        document.getElementById('modalDateNum').innerText = d;
        document.getElementById('modalDateFull').innerText = ds;
        document.getElementById('inpStart').value = ds;
        document.getElementById('inpEnd').value = ds;

        let h = '';
        if(evs.length === 0) h = '<p style="text-align:center;color:#999">Tidak ada kegiatan</p>';
        else {
            evs.forEach(e => {
                let btns = '';
                if(isAdminMode) btns = `<div><button class="btn-action-small" style="background:#2980b9" onclick="prepareEdit('${e.title}','${e.startDate}','${e.endDate}','${e.type}')">Edit</button><button class="btn-action-small" style="background:#c0392b" onclick="deleteEvent('${e.title}','${e.startDate}')">Hapus</button></div>`;
                h += `<div class="event-item-admin"><div><b>${e.title}</b><br><small>${e.startDate}</small></div>${btns}</div>`;
            });
        }
        document.getElementById('modalContent').innerHTML = h;
        document.getElementById('adminPanel').classList.toggle('show', isAdminMode);
        document.getElementById('dateModal').classList.add('active');
    }
    function closeModal() { document.getElementById('dateModal').classList.remove('active'); }

</script>
</body>
</html>